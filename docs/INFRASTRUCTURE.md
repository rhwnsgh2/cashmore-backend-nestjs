# 인프라 구조 문서

## 전체 아키텍처

```
[개발자] → [GitHub] → [GitHub Actions] → [AWS]
                            │
                            ▼
                    ┌───────────────┐
                    │  Docker 빌드   │
                    └───────┬───────┘
                            │
                            ▼
                    ┌───────────────┐
                    │   ECR 푸시     │  (Docker 이미지 저장소)
                    └───────┬───────┘
                            │
                            ▼
                    ┌───────────────┐
                    │   ECS 배포     │  (컨테이너 실행)
                    └───────────────┘
```

---

## AWS 리소스 설명

### 1. ECR (Elastic Container Registry)
- **역할**: Docker 이미지 저장소
- **비유**: Docker Hub의 AWS 버전
- **흐름**: GitHub Actions에서 빌드한 이미지를 여기에 푸시

### 2. ECS (Elastic Container Service)
- **역할**: 컨테이너 실행 및 관리
- **구성요소**:
  - **Cluster**: 컨테이너들이 실행되는 논리적 그룹
  - **Service**: 몇 개의 컨테이너를 유지할지 관리
  - **Task**: 실제 실행되는 컨테이너 인스턴스

### 3. Fargate
- **역할**: 서버 없이 컨테이너 실행
- **비유**: EC2 서버를 직접 관리하지 않고 컨테이너만 실행
- **장점**: 서버 관리 불필요, 자동 스케일링

### 4. ALB (Application Load Balancer)
- **역할**: 트래픽 분산
- **흐름**: 사용자 요청 → ALB → ECS 컨테이너
- **추가 기능**: HTTPS 처리, 헬스체크

### 5. Secrets Manager
- **역할**: 환경변수/비밀 저장
- **저장 내용**: DB 비밀번호, API 키 등
- **흐름**: ECS가 실행될 때 자동으로 환경변수로 주입

---

## 요청 흐름

```
사용자 → Route53(도메인) → ALB → ECS Fargate → NestJS 앱
                                      │
                                      ▼
                                  Supabase (DB)
```

---

## 배포 흐름

```
1. 코드 푸시 (main 브랜치)
        │
        ▼
2. GitHub Actions 트리거
        │
        ▼
3. 테스트 실행
        │
        ▼
4. Docker 이미지 빌드
        │
        ▼
5. ECR에 이미지 푸시
        │
        ▼
6. ECS 서비스 업데이트
        │
        ▼
7. 새 컨테이너 시작, 헬스체크 통과 후 트래픽 전환
        │
        ▼
8. 이전 컨테이너 종료
```

---

## 파일 역할 정리

| 파일 | 역할 | 언제 사용 |
|------|------|----------|
| `Dockerfile` | 이미지 빌드 방법 정의 | CI/CD에서 빌드할 때 |
| `infrastructure/` | AWS 리소스 정의 (CDK) | 인프라 생성/수정할 때 |
| `.github/workflows/` | CI/CD 파이프라인 | 코드 푸시할 때 자동 실행 |

---

## 비용 구조 (예상)

| 리소스 | 월 비용 (USD) | 비고 |
|--------|--------------|------|
| ECS Fargate | ~$30 | 0.5 vCPU, 1GB, 2개 태스크 |
| ALB | ~$20 | 고정 비용 |
| ECR | ~$1 | 이미지 저장 |
| Secrets Manager | ~$2 | 비밀 저장 |
| **합계** | **~$53** | |

---

## 다음 단계

1. [ ] AWS CDK로 인프라 코드 작성
2. [ ] Dockerfile 작성
3. [ ] GitHub Actions 워크플로우 작성
4. [ ] 첫 배포 테스트
